# NEXUS Web Dockerfile (Build-in-container)
# Builds the monorepo inside Docker (Node 20), then runs Next.js in a slim runtime image.

FROM node:20-alpine AS builder

WORKDIR /app
RUN apk add --no-cache libc6-compat curl git

ENV NODE_OPTIONS="--max-old-space-size=3072"
ENV NEXUS_BUILD_DTS="false"
ENV NEXUS_BUILD_SOURCEMAP="false"
ENV PNPM_WORKSPACE_CONCURRENCY="1"

# Copy only manifests first for better Docker layer caching.
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json tsconfig.json ./
COPY apps/web/package.json ./apps/web/package.json
COPY packages/ui/package.json ./packages/ui/package.json
COPY packages/core/package.json ./packages/core/package.json
COPY packages/config/package.json ./packages/config/package.json
COPY packages/ai/package.json ./packages/ai/package.json
COPY packages/db/package.json ./packages/db/package.json
COPY packages/git/package.json ./packages/git/package.json

RUN corepack enable pnpm \
  && pnpm install --frozen-lockfile --network-concurrency=1

COPY . .

RUN pnpm --filter @nexus/core build \
  && pnpm --filter @nexus/ui build \
  && pnpm --filter @nexus/web build

FROM node:20-alpine AS runner

WORKDIR /app
ENV NODE_ENV=production
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

RUN apk add --no-cache libc6-compat curl

RUN addgroup --system --gid 1001 nodejs \
  && adduser --system --uid 1001 nextjs

COPY --from=builder --chown=nextjs:nodejs /app /app

# Ensure the app root is writable (e.g. for runtime caches/logs if needed).
RUN chown nextjs:nodejs /app

USER nextjs
EXPOSE 3000

WORKDIR /app/apps/web
# Avoid relying on pnpm/corepack availability in the runtime image.
CMD ["node", "node_modules/next/dist/bin/next", "start", "-H", "0.0.0.0", "-p", "3000"]
